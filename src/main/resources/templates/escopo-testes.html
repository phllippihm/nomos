<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Escopo de Testes - Nomos</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#1e40af", secondary: "#3b82f6",
                        "background-light": "#f8fafc", "background-dark": "#0f172a",
                        "surface-light": "#ffffff", "surface-dark": "#1e293b",
                        "sidebar-light": "#ffffff", "sidebar-dark": "#111827",
                    },
                    fontFamily: { display: ["Inter", "sans-serif"], body: ["Inter", "sans-serif"] },
                    borderRadius: { DEFAULT: "0.5rem", xl: "1rem", '2xl': "1.5rem" },
                },
            },
        };
    </script>
    <style type="text/tailwindcss">
        body { font-family: 'Inter', sans-serif; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        input[type=range] { -webkit-appearance: none; appearance: none; height: 6px; border-radius: 999px; background: #e2e8f0; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #1e40af; cursor: pointer; border: 3px solid white; box-shadow: 0 1px 4px rgba(0,0,0,0.2); }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark text-slate-800 dark:text-slate-200 antialiased transition-colors duration-200">
    <div class="flex h-screen overflow-hidden">
        <div th:replace="~{fragments/sidebar :: sidebar}"></div>
        <main class="flex-1 overflow-y-auto">
            <header
                class="h-20 bg-surface-light/80 dark:bg-surface-dark/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 flex items-center justify-between px-10 sticky top-0 z-20">
                <div class="flex items-center gap-3">
                    <span class="text-[11px] font-bold text-slate-400 uppercase tracking-widest">Acesso Rápido:</span>
                    <div class="flex items-center bg-slate-100 dark:bg-slate-800 p-1 rounded-lg">
                        <button
                            class="px-3 py-1.5 text-xs font-semibold text-primary bg-white dark:bg-slate-700 rounded-md shadow-sm">Atalhos</button>
                        <button class="px-3 py-1.5 text-xs font-medium text-slate-500">Recentes</button>
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <div
                        class="flex items-center gap-2 px-3 py-1.5 bg-blue-50 text-primary rounded-full border border-blue-100">
                        <span class="material-symbols-outlined text-base">person_search</span>
                        <span class="text-[11px] font-bold uppercase tracking-wider">Simular Perfil: Master Root</span>
                    </div>
                </div>
            </header>

            <div class="p-10 max-w-[1400px] mx-auto space-y-10 pb-20">
                <div>
                    <h1 class="text-3xl font-extrabold text-slate-900 dark:text-white tracking-tight">Cadastro de Escopo
                        Técnico</h1>
                    <p class="text-slate-500 mt-2 text-lg">Defina os ensaios laboratoriais e sua criticidade para a
                        unidade.</p>
                </div>

                <!-- Tabs -->
                <div class="flex gap-8 border-b border-slate-200 dark:border-slate-700">
                    <button onclick="switchTab('form')" id="tab-form"
                        class="tab-btn pb-4 text-sm font-bold border-b-2 border-primary text-primary transition-all">Formulário
                        de Cadastro</button>
                    <button onclick="switchTab('list')" id="tab-list"
                        class="tab-btn pb-4 text-sm font-bold border-b-2 border-transparent text-slate-400 transition-all">Visualizar
                        Escopos</button>
                </div>

                <!-- ==================== FORM TAB ==================== -->
                <div id="panel-form" class="tab-panel">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Left: form fields -->
                        <div
                            class="lg:col-span-2 bg-white dark:bg-slate-800 p-8 rounded-3xl border border-slate-200/60 dark:border-slate-700 shadow-sm space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="space-y-1">
                                    <label
                                        class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Diretoria</label>
                                    <select id="frm-diretoria"
                                        class="w-full p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl outline-none focus:ring-2 focus:ring-blue-500/20 text-sm">
                                        <option value="">Escolher...</option>
                                    </select>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Área
                                        Técnica</label>
                                    <select id="frm-area"
                                        class="w-full p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl outline-none focus:ring-2 focus:ring-blue-500/20 text-sm">
                                        <option value="">Escolher...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Nome do
                                    Teste / Ensaio</label>
                                <input type="text" id="frm-teste"
                                    class="w-full p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl outline-none font-bold text-sm" />
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Descrição
                                    do Teste (Instruções Técnicas)</label>
                                <textarea id="frm-descricao"
                                    class="w-full p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl outline-none min-h-[100px] text-sm"
                                    placeholder="Descreva os critérios de aceitação, normas e métodos..."></textarea>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="space-y-1">
                                    <label
                                        class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Periodicidade
                                        de Execução</label>
                                    <select id="frm-periodicidade" onchange="togglePeriodicidade()"
                                        class="w-full p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl outline-none text-sm">
                                        <option value="Mensal">Mensal</option>
                                        <option value="Bimestral">Bimestral</option>
                                        <option value="Trimestral">Trimestral</option>
                                        <option value="Semestral">Semestral</option>
                                        <option value="Irregular">Irregular (Manual)</option>
                                    </select>
                                </div>
                                <div id="mesInicio-group" class="space-y-1">
                                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Mês de
                                        Início Ciclo</label>
                                    <select id="frm-mesInicio"
                                        class="w-full p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl outline-none text-sm">
                                        <option value="">Selecione...</option>
                                    </select>
                                </div>
                            </div>
                            <!-- Irregular months selector -->
                            <div id="irregular-months"
                                class="hidden p-4 bg-blue-50 dark:bg-blue-900/20 rounded-2xl border border-blue-100 dark:border-blue-800">
                                <label
                                    class="text-[10px] font-bold text-primary uppercase mb-3 block tracking-widest">Selecione
                                    os meses de execução:</label>
                                <div id="months-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2">
                                </div>
                            </div>
                            <div class="pt-6 border-t border-slate-100 dark:border-slate-700 space-y-3">
                                <button onclick="handleSave(false)"
                                    class="w-full py-4 text-slate-500 font-bold bg-slate-50 dark:bg-slate-900 rounded-2xl hover:bg-slate-100 transition-all">Apenas
                                    Salvar Dados</button>
                                <button onclick="handleSave(true)"
                                    class="w-full py-4 bg-primary text-white font-bold rounded-2xl shadow-lg hover:bg-blue-700 transition-all">Salvar
                                    e Gerar Calendário</button>
                            </div>
                        </div>

                        <!-- Right: Risk panel -->
                        <div class="space-y-6">
                            <div
                                class="bg-white dark:bg-slate-800 p-8 rounded-3xl border border-slate-200/60 dark:border-slate-700 shadow-sm flex flex-col items-center">
                                <h3
                                    class="font-extrabold text-slate-900 dark:text-white mb-6 uppercase text-[10px] tracking-widest text-center">
                                    Criticidade do Teste (Matriz de Risco)</h3>
                                <div id="risk-sliders" class="w-full space-y-6"></div>
                                <div id="risk-result"
                                    class="mt-10 p-6 rounded-3xl w-full text-center border-2 transition-all duration-500 border-slate-200 bg-slate-50">
                                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Score Total: <span
                                            id="risk-score">0</span></p>
                                    <p id="risk-label"
                                        class="text-xl font-extrabold uppercase tracking-tight text-slate-400">N/A</p>
                                </div>
                            </div>
                            <div class="bg-slate-900 p-6 rounded-3xl text-white shadow-xl">
                                <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4">
                                    Informações Complementares</h4>
                                <div class="space-y-4">
                                    <div class="space-y-1">
                                        <label class="text-[9px] font-bold text-slate-500 uppercase">Finalidade do
                                            Teste</label>
                                        <input type="text" id="frm-finalidade"
                                            class="w-full bg-transparent border-b border-slate-700 p-1 text-xs outline-none focus:border-blue-500"
                                            placeholder="Ex: Qualidade de Água" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-[9px] font-bold text-slate-500 uppercase">Base
                                            Normativa</label>
                                        <input type="text" id="frm-baseNormativa"
                                            class="w-full bg-transparent border-b border-slate-700 p-1 text-xs outline-none focus:border-blue-500"
                                            placeholder="Ex: RDC 222/2018" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== LIST TAB ==================== -->
                <div id="panel-list" class="tab-panel hidden">
                    <div
                        class="bg-white dark:bg-slate-800 rounded-3xl border border-slate-200/60 dark:border-slate-700 shadow-sm overflow-hidden">
                        <table class="w-full text-left">
                            <thead
                                class="bg-slate-50 dark:bg-slate-900/50 text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                                <tr>
                                    <th class="px-8 py-5">Nome do Teste / Unidade</th>
                                    <th class="px-8 py-5">Periodicidade</th>
                                    <th class="px-8 py-5">Risco</th>
                                    <th class="px-6 py-5 text-right">Ação</th>
                                </tr>
                            </thead>
                            <tbody id="scopes-tbody" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
                        </table>
                        <div id="scopes-empty"
                            class="hidden px-8 py-20 text-center text-slate-300 font-bold uppercase tracking-widest text-xs">
                            Nenhum escopo cadastrado para esta unidade.
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast -->
    <div id="toast"
        class="fixed bottom-6 right-6 bg-emerald-600 text-white px-6 py-3 rounded-2xl shadow-2xl font-bold text-sm z-[300] transition-all duration-500 opacity-0 translate-y-4 pointer-events-none flex items-center gap-2">
        <span class="material-symbols-outlined text-lg">check_circle</span>
        <span id="toast-msg">Salvo!</span>
    </div>

    <script>
        const MESES = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

        const currentUser = JSON.parse(localStorage.getItem('nomos_current_session') || JSON.stringify({
            id: 'master-0', name: 'Master Root', email: 'root@nomos.lab', role: 'Master', position: 'Admin Global', empresaId: ''
        }));

        let matrixState = null;
        let scopes = [];
        let empEstrutura = { diretorias: [], areas: [], centrosCusto: [] };
        let editingId = null;
        let selectedMonths = [];
        let riskValues = {};

        // ====================== INIT ======================
        function init() {
            // Determine empresaId - use first empresa if Master has none set
            if (!currentUser.empresaId) {
                const empresas = JSON.parse(localStorage.getItem('nomos_empresas') || '[]');
                if (empresas.length > 0) currentUser.empresaId = empresas[0].id;
            }

            // Load matrix config
            const savedMatrix = localStorage.getItem('nomos_matrix_config_' + currentUser.empresaId);
            if (savedMatrix) matrixState = JSON.parse(savedMatrix);

            // Load scopes
            const allScopes = JSON.parse(localStorage.getItem('nomos_scopes') || '[]');
            scopes = allScopes.filter(s => s.empresaId === currentUser.empresaId);

            // Load org structure
            const allEstruturas = JSON.parse(localStorage.getItem('nomos_estrutura') || '{}');
            if (currentUser.empresaId && allEstruturas[currentUser.empresaId]) {
                empEstrutura = allEstruturas[currentUser.empresaId];
            }

            // Populate selects
            populateOrgSelects();
            populateMonthSelects();
            renderRiskSliders();
            renderScopesList();
            renderMonthsGrid();
        }

        function populateOrgSelects() {
            const dirSelect = document.getElementById('frm-diretoria');
            dirSelect.innerHTML = '<option value="">Escolher...</option>' +
                (empEstrutura.diretorias || []).map(d => `<option value="${d}">${d}</option>`).join('');
            const areaSelect = document.getElementById('frm-area');
            areaSelect.innerHTML = '<option value="">Escolher...</option>' +
                (empEstrutura.areas || []).map(a => `<option value="${a}">${a}</option>`).join('');
        }

        function populateMonthSelects() {
            document.getElementById('frm-mesInicio').innerHTML = '<option value="">Selecione...</option>' +
                MESES.map(m => `<option value="${m}">${m}</option>`).join('');
        }

        // ====================== TAB SWITCHING ======================
        function switchTab(tab) {
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('border-primary', 'text-primary');
                b.classList.add('border-transparent', 'text-slate-400');
            });
            document.getElementById('panel-' + tab).classList.remove('hidden');
            const btn = document.getElementById('tab-' + tab);
            btn.classList.add('border-primary', 'text-primary');
            btn.classList.remove('border-transparent', 'text-slate-400');
        }

        // ====================== PERIODICIDADE ======================
        function togglePeriodicidade() {
            const per = document.getElementById('frm-periodicidade').value;
            document.getElementById('mesInicio-group').classList.toggle('hidden', per === 'Irregular');
            document.getElementById('irregular-months').classList.toggle('hidden', per !== 'Irregular');
        }

        function renderMonthsGrid() {
            document.getElementById('months-grid').innerHTML = MESES.map(m => {
                const active = selectedMonths.includes(m);
                return `<button onclick="toggleMonth('${m}')" class="px-2 py-1.5 rounded-lg text-[9px] font-bold border transition-all ${active ? 'bg-primary text-white border-blue-600 shadow-sm' : 'bg-white text-slate-400 border-slate-200 dark:bg-slate-800 dark:border-slate-600'}">${m.substring(0, 3)}</button>`;
            }).join('');
        }

        function toggleMonth(m) {
            if (selectedMonths.includes(m)) {
                selectedMonths = selectedMonths.filter(x => x !== m);
            } else {
                selectedMonths.push(m);
            }
            renderMonthsGrid();
        }

        // ====================== RISK CALCULATOR ======================
        function renderRiskSliders() {
            const container = document.getElementById('risk-sliders');
            if (!matrixState || !matrixState.riskDimensions || matrixState.riskDimensions.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-400 text-xs py-6">Configure a Matriz de Risco primeiro em <strong>Parametrizar Matrizes</strong>.</p>';
                return;
            }
            container.innerHTML = matrixState.riskDimensions.map(dim => {
                const val = riskValues[dim.id] || 1;
                return `
                <div class="space-y-2">
                    <div class="flex justify-between text-[10px] font-bold text-slate-400 uppercase">
                        <span>${dim.name}</span>
                        <span class="text-primary bg-blue-50 px-2 py-0.5 rounded">Nota: <span id="val-${dim.id}">${val}</span></span>
                    </div>
                    <input type="range" min="1" max="5" step="1" value="${val}"
                        oninput="updateRiskValue('${dim.id}', this.value)"
                        class="w-full" />
                </div>`;
            }).join('');
            updateRiskDisplay();
        }

        function updateRiskValue(dimId, val) {
            riskValues[dimId] = parseInt(val);
            document.getElementById('val-' + dimId).textContent = val;
            updateRiskDisplay();
        }

        function calculateRisk() {
            if (!matrixState || !matrixState.riskDimensions) return { score: 0, level: 'N/A', color: '#e2e8f0' };
            const score = matrixState.riskDimensions.reduce((acc, dim) => acc * (riskValues[dim.id] || 1), 1);
            const range = matrixState.riskRanges.find(r => score >= r.min && score <= r.max);
            return { score, level: range?.label || 'Nível Indefinido', color: range?.color || '#e2e8f0' };
        }

        function updateRiskDisplay() {
            const r = calculateRisk();
            document.getElementById('risk-score').textContent = r.score;
            document.getElementById('risk-label').textContent = 'Risco ' + r.level;
            document.getElementById('risk-label').style.color = r.color;
            const box = document.getElementById('risk-result');
            box.style.borderColor = r.color;
            box.style.backgroundColor = r.color + '15';
        }

        // ====================== SCOPES LIST ======================
        function renderScopesList() {
            const tbody = document.getElementById('scopes-tbody');
            const empty = document.getElementById('scopes-empty');
            if (scopes.length === 0) { tbody.innerHTML = ''; empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden');
            tbody.innerHTML = scopes.map(s => {
                const range = matrixState?.riskRanges?.find(r => r.label === s.riskLevel);
                const color = range?.color || '#94a3b8';
                return `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                    <td class="px-8 py-5">
                        <p class="font-bold text-slate-900 dark:text-white text-sm">${s.teste}</p>
                        <p class="text-[10px] text-slate-400 font-bold uppercase mt-0.5">${s.area || ''} • ${s.centroCusto || ''}</p>
                    </td>
                    <td class="px-8 py-5 text-xs text-slate-500 font-medium">${s.periodicidade}</td>
                    <td class="px-8 py-5">
                        <span class="text-[10px] font-bold uppercase px-2.5 py-1 rounded-full border" style="color:${color}; border-color:${color}40; background:${color}10">${s.riskLevel || 'N/A'}</span>
                    </td>
                    <td class="px-6 py-5 text-right">
                        <button onclick="editScope('${s.id}')" class="text-primary text-xs font-bold hover:underline">Editar</button>
                        <button onclick="deleteScope('${s.id}')" class="text-red-400 text-xs font-bold hover:underline ml-3">Excluir</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function editScope(id) {
            const s = scopes.find(x => x.id === id);
            if (!s) return;
            editingId = s.id;
            document.getElementById('frm-diretoria').value = s.diretoria || '';
            document.getElementById('frm-area').value = s.area || '';
            document.getElementById('frm-teste').value = s.teste || '';
            document.getElementById('frm-descricao').value = s.descricao || '';
            document.getElementById('frm-periodicidade').value = s.periodicidade || 'Mensal';
            document.getElementById('frm-mesInicio').value = s.mesInicio || '';
            document.getElementById('frm-finalidade').value = s.finalidade || '';
            document.getElementById('frm-baseNormativa').value = s.baseNormativa || '';
            riskValues = { ...(s.riskValues || {}) };
            selectedMonths = [...(s.mesesExecucao || [])];
            togglePeriodicidade();
            renderRiskSliders();
            renderMonthsGrid();
            switchTab('form');
        }

        function deleteScope(id) {
            if (!confirm('Excluir este escopo?')) return;
            const allScopes = JSON.parse(localStorage.getItem('nomos_scopes') || '[]');
            const updated = allScopes.filter(s => s.id !== id);
            localStorage.setItem('nomos_scopes', JSON.stringify(updated));
            scopes = updated.filter(s => s.empresaId === currentUser.empresaId);
            renderScopesList();
            showToast('Escopo excluído.');
        }

        // ====================== SAVE ======================
        function handleSave(generateCalendar) {
            const teste = document.getElementById('frm-teste').value.trim();
            const diretoria = document.getElementById('frm-diretoria').value;
            const area = document.getElementById('frm-area').value;
            if (!teste || !diretoria || !area) { alert('Preencha Nome do Teste, Diretoria e Área.'); return; }

            const risk = calculateRisk();
            const newItem = {
                id: editingId || Date.now().toString(),
                empresaId: currentUser.empresaId,
                teste, diretoria, area,
                descricao: document.getElementById('frm-descricao').value,
                periodicidade: document.getElementById('frm-periodicidade').value,
                mesInicio: document.getElementById('frm-mesInicio').value,
                mesesExecucao: selectedMonths,
                finalidade: document.getElementById('frm-finalidade').value,
                baseNormativa: document.getElementById('frm-baseNormativa').value,
                riskValues: { ...riskValues },
                score: risk.score,
                riskLevel: risk.level,
                centroCusto: ''
            };

            const allScopes = JSON.parse(localStorage.getItem('nomos_scopes') || '[]');
            let updated;
            if (editingId) {
                updated = allScopes.map(s => s.id === editingId ? newItem : s);
            } else {
                updated = [...allScopes, newItem];
            }
            localStorage.setItem('nomos_scopes', JSON.stringify(updated));
            scopes = updated.filter(s => s.empresaId === currentUser.empresaId);

            if (generateCalendar) {
                generatePlanningItems(newItem);
                showToast('Escopo salvo e calendário gerado!');
            } else {
                showToast('Escopo salvo com sucesso!');
            }

            // Reset form
            editingId = null;
            riskValues = {};
            selectedMonths = [];
            document.getElementById('frm-teste').value = '';
            document.getElementById('frm-descricao').value = '';
            document.getElementById('frm-periodicidade').value = 'Mensal';
            document.getElementById('frm-mesInicio').value = '';
            document.getElementById('frm-finalidade').value = '';
            document.getElementById('frm-baseNormativa').value = '';
            renderRiskSliders();
            renderMonthsGrid();
            renderScopesList();
            switchTab('list');
        }

        function generatePlanningItems(scope) {
            const allPlans = JSON.parse(localStorage.getItem('nomos_planning') || '[]');
            // Remove existing plans for this scope
            const filtered = allPlans.filter(p => p.scopeId !== scope.id);

            let months = [];
            const currentYear = new Date().getFullYear().toString();

            if (scope.periodicidade === 'Irregular') {
                months = scope.mesesExecucao || [];
            } else {
                const startIdx = scope.mesInicio ? MESES.indexOf(scope.mesInicio) : 0;
                const step = scope.periodicidade === 'Mensal' ? 1 :
                    scope.periodicidade === 'Bimestral' ? 2 :
                        scope.periodicidade === 'Trimestral' ? 3 : 6;
                for (let i = startIdx; i < 12; i += step) {
                    months.push(MESES[i]);
                }
            }

            const newPlans = months.map(mes => ({
                id: Date.now().toString() + '-' + mes,
                scopeId: scope.id,
                empresaId: scope.empresaId,
                testName: scope.teste,
                area: scope.area,
                diretoria: scope.diretoria,
                riskLevel: scope.riskLevel,
                mes, ano: currentYear,
                status: 'Pendente'
            }));

            localStorage.setItem('nomos_planning', JSON.stringify([...filtered, ...newPlans]));
        }

        // ====================== TOAST ======================
        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').textContent = msg;
            t.classList.remove('opacity-0', 'translate-y-4');
            t.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => { t.classList.add('opacity-0', 'translate-y-4'); t.classList.remove('opacity-100', 'translate-y-0'); }, 3000);
        }

        init();
    </script>
</body>

</html>