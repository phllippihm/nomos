<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Parametrizar Matrizes - Nomos</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#1e40af",
                        secondary: "#3b82f6",
                        accent: "#f59e0b",
                        "background-light": "#f8fafc",
                        "background-dark": "#0f172a",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1e293b",
                        "sidebar-light": "#ffffff",
                        "sidebar-dark": "#111827",
                        "icon-pastel": "#e0e7ff",
                    },
                    fontFamily: {
                        display: ["Inter", "sans-serif"],
                        body: ["Inter", "sans-serif"],
                    },
                },
            },
        };
    </script>
    <style type="text/tailwindcss">
        body { font-family: 'Inter', sans-serif; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark text-slate-800 dark:text-slate-200 antialiased transition-colors duration-200">
    <div class="flex h-screen overflow-hidden">
        <div th:replace="~{fragments/sidebar :: sidebar}"></div>
        <main class="flex-1 overflow-y-auto">
            <header
                class="h-20 bg-surface-light/80 dark:bg-surface-dark/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 flex items-center justify-between px-10 sticky top-0 z-20">
                <div class="flex items-center gap-8">
                    <div class="flex items-center gap-3">
                        <span class="text-[11px] font-bold text-slate-400 uppercase tracking-widest">Acesso
                            Rápido:</span>
                        <div class="flex items-center bg-slate-100 dark:bg-slate-800 p-1 rounded-lg">
                            <button
                                class="px-3 py-1.5 text-xs font-semibold text-primary bg-white dark:bg-slate-700 rounded-md shadow-sm">Atalhos</button>
                            <button
                                class="px-3 py-1.5 text-xs font-medium text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">Recentes</button>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <div
                        class="flex items-center gap-2 px-3 py-1.5 bg-blue-50 dark:bg-blue-900/20 text-primary dark:text-blue-400 rounded-full border border-blue-100 dark:border-blue-900/30">
                        <span class="material-symbols-outlined text-base">person_search</span>
                        <span class="text-[11px] font-bold uppercase tracking-wider">Simular Perfil: Master Root</span>
                    </div>
                    <div class="h-8 w-[1px] bg-slate-200 dark:bg-slate-800"></div>
                    <button class="p-2 text-slate-400 hover:text-primary transition-colors">
                        <span class="material-symbols-outlined">notifications</span>
                    </button>
                </div>
            </header>

            <div class="p-10 max-w-[1400px] mx-auto space-y-8">

                <!-- Toast Notification (shared) -->
                <div id="toast"
                    class="fixed top-24 right-8 bg-emerald-500 text-white px-6 py-3 rounded-xl shadow-xl z-[100] flex items-center gap-3 transition-all duration-300 opacity-0 pointer-events-none translate-x-4">
                    <span class="material-symbols-outlined text-xl">check_circle</span>
                    <span id="toastMessage" class="font-medium">Salvo com sucesso!</span>
                </div>

                <!-- Page Header & Tabs -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h1 class="text-3xl font-extrabold text-slate-900 dark:text-white tracking-tight">Parametrização
                            de Matrizes</h1>
                        <p class="text-slate-500 dark:text-slate-400 mt-1">Configurações para a unidade: <strong
                                class="text-slate-900 dark:text-white">Global</strong></p>
                    </div>
                    <div class="bg-slate-100 dark:bg-slate-800/50 p-1 rounded-xl flex space-x-1 shadow-inner">
                        <button onclick="switchTab('risk')" id="tab-risk"
                            class="tab-btn px-5 py-2.5 text-sm font-bold rounded-lg transition-all text-slate-500 hover:text-slate-700 dark:text-slate-400">
                            <span class="material-symbols-outlined text-base align-middle mr-1">warning</span>Risco
                        </button>
                        <button onclick="switchTab('compliance')" id="tab-compliance"
                            class="tab-btn px-5 py-2.5 text-sm font-bold rounded-lg transition-all text-slate-500 hover:text-slate-700 dark:text-slate-400">
                            <span
                                class="material-symbols-outlined text-base align-middle mr-1">verified</span>Conformidade
                        </button>
                        <button onclick="switchTab('maintenance')" id="tab-maintenance"
                            class="tab-btn px-5 py-2.5 text-sm font-bold rounded-lg transition-all text-slate-500 hover:text-slate-700 dark:text-slate-400">
                            <span class="material-symbols-outlined text-base align-middle mr-1">build</span>Manutenção
                        </button>
                    </div>
                </div>

                <!-- ========== RISK TAB ========== -->
                <div id="content-risk" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Left: Dimensions + Ranges -->
                        <div class="space-y-6">
                            <!-- Dimensions -->
                            <div
                                class="bg-surface-light dark:bg-surface-dark p-6 rounded-2xl border border-slate-200/60 dark:border-slate-800 shadow-sm">
                                <div class="flex justify-between items-center mb-5">
                                    <h3 class="text-base font-bold text-slate-900 dark:text-white flex items-center">
                                        <span class="w-1.5 h-5 bg-primary rounded mr-3"></span>Configuração de Dimensões
                                    </h3>
                                    <span id="riskScoreInfo"
                                        class="text-[10px] font-bold text-slate-400 bg-slate-100 dark:bg-slate-800 px-2.5 py-1 rounded-lg"></span>
                                </div>
                                <div id="dimensionsList" class="space-y-3"></div>
                                <button onclick="addDimension()"
                                    class="mt-4 text-sm font-bold text-primary hover:text-blue-700 dark:text-blue-400 flex items-center transition-colors">
                                    <span class="material-symbols-outlined mr-1 text-lg">add_circle</span>
                                    Adicionar nova dimensão
                                </button>
                            </div>

                            <!-- Risk Ranges -->
                            <div
                                class="bg-surface-light dark:bg-surface-dark p-6 rounded-2xl border border-slate-200/60 dark:border-slate-800 shadow-sm">
                                <div class="flex justify-between items-center mb-5">
                                    <h4
                                        class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest">
                                        Faixas de Risco</h4>
                                    <button onclick="addRiskRange()"
                                        class="text-xs font-bold text-primary hover:text-blue-700 dark:text-blue-400 flex items-center">
                                        <span class="material-symbols-outlined mr-1 text-base">add</span>ADICIONAR
                                    </button>
                                </div>
                                <div id="riskRangesList" class="space-y-2"></div>
                            </div>
                        </div>

                        <!-- Right: Heatmap + Save -->
                        <div class="space-y-6">
                            <div
                                class="bg-surface-light dark:bg-surface-dark p-6 rounded-2xl border border-slate-200/60 dark:border-slate-800 shadow-sm flex flex-col">
                                <h3 class="text-base font-bold text-slate-900 dark:text-white mb-1">Preview Visual
                                    (Heatmap 2D)</h3>
                                <p id="heatmapInfo" class="text-[10px] text-slate-400 mb-5 uppercase tracking-wider">
                                </p>
                                <div class="flex w-full justify-center flex-1">
                                    <div id="yAxisLabel"
                                        class="flex items-center [writing-mode:vertical-lr] rotate-180 mr-3 text-xs font-bold text-slate-400 uppercase tracking-widest whitespace-nowrap">
                                    </div>
                                    <div class="flex flex-col flex-1 max-w-lg">
                                        <div id="heatmapGrid" class="grid gap-0.5 flex-1"></div>
                                        <div id="xAxisLabel"
                                            class="mt-3 text-center text-xs font-bold text-slate-400 uppercase tracking-widest whitespace-nowrap">
                                        </div>
                                    </div>
                                </div>
                                <button onclick="saveRisk()"
                                    class="mt-6 w-full py-4 bg-primary text-white font-bold rounded-xl shadow-lg shadow-blue-900/20 hover:bg-blue-700 active:scale-[0.98] transition-all uppercase tracking-widest text-sm">
                                    Salvar Parametrização de Risco
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== COMPLIANCE TAB ========== -->
                <div id="content-compliance" class="tab-content hidden">
                    <div
                        class="bg-surface-light dark:bg-surface-dark p-8 rounded-3xl border border-slate-200/60 dark:border-slate-800 shadow-sm">
                        <div class="mb-8">
                            <h3 class="text-xl font-bold text-slate-900 dark:text-white">Matriz de Conformidade</h3>
                            <p class="text-slate-500 dark:text-slate-400 mt-1">Defina os níveis de conformidade
                                esperados e configure os gatilhos de alerta.</p>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                            <!-- Left: Table -->
                            <div class="space-y-6">
                                <div
                                    class="overflow-hidden rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm">
                                    <table class="w-full text-left">
                                        <thead
                                            class="bg-slate-50 dark:bg-slate-800/50 text-[11px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider">
                                            <tr>
                                                <th class="px-5 py-3.5">Intervalo (%)</th>
                                                <th class="px-5 py-3.5">Nível</th>
                                                <th class="px-5 py-3.5">Cor</th>
                                                <th class="px-5 py-3.5 text-center">Notificar?</th>
                                                <th class="px-5 py-3.5"></th>
                                            </tr>
                                        </thead>
                                        <tbody id="complianceTableBody"
                                            class="divide-y divide-slate-100 dark:divide-slate-800 bg-white dark:bg-slate-900/50">
                                        </tbody>
                                    </table>
                                </div>
                                <button onclick="addComplianceRange()"
                                    class="flex items-center text-sm font-bold text-primary hover:text-blue-700 dark:text-blue-400 transition-colors uppercase tracking-wide">
                                    <span class="material-symbols-outlined mr-2 text-lg">add_circle</span>
                                    Adicionar Novo Nível
                                </button>
                            </div>
                            <!-- Right: Viz + Save -->
                            <div class="space-y-8">
                                <div
                                    class="bg-slate-50 dark:bg-slate-800/50 p-6 rounded-2xl border border-slate-100 dark:border-slate-800">
                                    <h4
                                        class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase mb-5 tracking-widest">
                                        Visualização Linear das Faixas</h4>
                                    <div id="complianceVizBar"
                                        class="h-12 w-full flex rounded-full overflow-hidden shadow-inner bg-slate-200 dark:bg-slate-700">
                                    </div>
                                </div>
                                <div
                                    class="bg-blue-50 dark:bg-blue-900/10 p-5 rounded-2xl border border-blue-100 dark:border-blue-900/30 flex items-start shadow-sm">
                                    <div
                                        class="bg-primary p-2 rounded-lg text-white mr-4 mt-0.5 shadow-sm shadow-blue-500/20">
                                        <span class="material-symbols-outlined text-xl">notifications_active</span>
                                    </div>
                                    <div>
                                        <h5 class="font-bold text-blue-900 dark:text-blue-100 text-sm">Gatilho de
                                            Notificação Ativo</h5>
                                        <p class="text-blue-800 dark:text-blue-300 text-xs mt-1 leading-relaxed">
                                            Alertas automáticos para conformidade nível <strong
                                                id="complianceThresholdLabel" class="font-bold">"..."</strong> ou
                                            inferior.
                                        </p>
                                    </div>
                                </div>
                                <button onclick="saveCompliance()"
                                    class="w-full py-4 bg-primary text-white font-bold rounded-xl shadow-lg shadow-blue-900/20 hover:bg-blue-700 active:scale-[0.98] transition-all uppercase tracking-widest text-sm">
                                    Salvar Parametrização de Conformidade
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== MAINTENANCE TAB ========== -->
                <div id="content-maintenance" class="tab-content hidden">
                    <div
                        class="bg-surface-light dark:bg-surface-dark p-8 rounded-3xl border border-slate-200/60 dark:border-slate-800 shadow-sm">
                        <div class="mb-8">
                            <h3 class="text-xl font-bold text-slate-900 dark:text-white">Matriz de Manutenção e Plano de
                                Ação</h3>
                            <p class="text-slate-500 dark:text-slate-400 mt-1">Configure as ações automáticas baseadas
                                no cruzamento de Risco e Conformidade.</p>
                        </div>
                        <!-- Legend -->
                        <div class="flex flex-wrap gap-4 mb-6">
                            <div class="flex items-center gap-2 text-xs font-bold">
                                <span class="w-3 h-3 rounded bg-emerald-100 border border-emerald-200"></span>
                                <span class="text-emerald-700">Sem acompanhamento</span>
                            </div>
                            <div class="flex items-center gap-2 text-xs font-bold">
                                <span class="w-3 h-3 rounded bg-amber-100 border border-amber-200"></span>
                                <span class="text-amber-700">Com acompanhamento</span>
                            </div>
                            <div class="flex items-center gap-2 text-xs font-bold">
                                <span class="w-3 h-3 rounded bg-red-100 border border-red-200"></span>
                                <span class="text-red-700">Plano de ação</span>
                            </div>
                            <span class="text-[10px] text-slate-400 ml-auto self-center">Clique nas células para
                                alternar</span>
                        </div>
                        <div class="overflow-x-auto rounded-2xl border border-slate-200 dark:border-slate-700">
                            <table id="maintenanceTable" class="w-full border-collapse"></table>
                        </div>
                        <div class="mt-8 flex justify-end">
                            <button onclick="saveMaintenance()"
                                class="px-10 py-4 bg-primary text-white font-bold rounded-xl shadow-lg shadow-blue-900/20 hover:bg-blue-700 active:scale-[0.98] transition-all uppercase tracking-widest text-sm">
                                Salvar Matriz de Manutenção
                            </button>
                        </div>
                    </div>
                </div>

            </div><!-- /max-w -->
        </main>
    </div>

    <script>
        // =====================================================================
        // CENTRALIZED STATE (mirrors MatrixState from React)
        // =====================================================================
        const STORAGE_KEY = 'nomos_matrix_config_global';
        const MAINTENANCE_ACTIONS = [
            'Em manutenção sem acompanhamento',
            'Em manutenção com acompanhamento',
            'Necessita plano de ação'
        ];

        let state = loadState();

        function defaultState() {
            return {
                empresaId: 'global',
                riskDimensions: [
                    { id: '1', name: 'Impacto' },
                    { id: '2', name: 'Probabilidade' }
                ],
                riskRanges: [
                    { id: '1', min: 1, max: 5, label: 'Baixo', color: '#10b981' },
                    { id: '2', min: 6, max: 15, label: 'Médio', color: '#f59e0b' },
                    { id: '3', min: 16, max: 25, label: 'Alto', color: '#ef4444' }
                ],
                complianceRanges: [
                    { id: 'c1', min: 0, max: 49, label: 'Crítico', color: '#ef4444' },
                    { id: 'c2', min: 50, max: 74, label: 'Regular', color: '#f59e0b' },
                    { id: 'c3', min: 75, max: 89, label: 'Bom', color: '#3b82f6' },
                    { id: 'c4', min: 90, max: 100, label: 'Excelente', color: '#10b981' }
                ],
                notificationThresholdId: 'c3',
                maintenanceMatrix: {}
            };
        }

        function loadState() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) return JSON.parse(saved);
            } catch (e) { console.warn('Failed to load state', e); }
            return defaultState();
        }

        function saveState() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            localStorage.setItem('nomos_matrix_config', JSON.stringify(state));
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = msg;
            t.classList.remove('opacity-0', 'pointer-events-none', 'translate-x-4');
            setTimeout(() => t.classList.add('opacity-0', 'pointer-events-none', 'translate-x-4'), 3000);
        }

        // =====================================================================
        // TAB SWITCHING
        // =====================================================================
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.className = 'tab-btn px-5 py-2.5 text-sm font-bold rounded-lg transition-all text-slate-500 hover:text-slate-700 dark:text-slate-400';
            });
            document.querySelectorAll('.tab-content').forEach(c => { c.classList.add('hidden'); });

            const btn = document.getElementById('tab-' + tabId);
            btn.className = 'tab-btn px-5 py-2.5 text-sm font-bold rounded-lg transition-all bg-white dark:bg-slate-700 text-primary dark:text-blue-400 shadow-sm';
            document.getElementById('content-' + tabId).classList.remove('hidden');

            // Re-render active tab
            if (tabId === 'risk') renderRisk();
            else if (tabId === 'compliance') renderCompliance();
            else if (tabId === 'maintenance') renderMaintenance();
        }

        // =====================================================================
        // RISK MATRIX EDITOR
        // =====================================================================
        function renderRisk() {
            renderDimensions();
            renderRiskRanges();
            renderHeatmap();
        }

        function renderDimensions() {
            const container = document.getElementById('dimensionsList');
            container.innerHTML = '';
            state.riskDimensions.forEach((dim, i) => {
                const axisLabel = i < 2 ? ` (Eixo ${i === 0 ? 'Y' : 'X'})` : ' (Fator Mult.)';
                const canDelete = state.riskDimensions.length > 2;
                const div = document.createElement('div');
                div.className = 'group';
                div.innerHTML = `
                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Dimensão ${i + 1}${axisLabel}</label>
                <div class="flex items-center space-x-2">
                    <input type="text" value="${dim.name}" data-dim-id="${dim.id}"
                        class="flex-1 p-2.5 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm focus:ring-2 focus:ring-primary/50 outline-none transition-all"
                        oninput="updateDimensionName('${dim.id}', this.value)">
                    ${canDelete ? `
                    <button onclick="removeDimension('${dim.id}')" class="p-2 text-slate-300 hover:text-red-500 transition-colors" title="Remover">
                        <span class="material-symbols-outlined text-xl">delete</span>
                    </button>` : ''}
                </div>
            `;
                container.appendChild(div);
            });
            const maxVal = state.riskRanges.length > 0 ? Math.max(...state.riskRanges.map(r => r.max)) : 25;
            const axisLimit = Math.min(22, Math.max(5, Math.ceil(Math.sqrt(maxVal))));
            const maxScore = Math.pow(axisLimit, state.riskDimensions.length);
            document.getElementById('riskScoreInfo').textContent = `SCORE MÁX (Escala ${axisLimit}): ${maxScore}`;
        }

        function addDimension() {
            state.riskDimensions.push({ id: Date.now().toString(), name: 'Nova Dimensão' });
            renderRisk();
        }

        function removeDimension(id) {
            if (state.riskDimensions.length <= 2) {
                alert('A matriz de risco deve ter no mínimo 2 dimensões.');
                return;
            }
            state.riskDimensions = state.riskDimensions.filter(d => d.id !== id);
            renderRisk();
        }

        function updateDimensionName(id, name) {
            state.riskDimensions = state.riskDimensions.map(d => d.id === id ? { ...d, name } : d);
            // Update axis labels without full re-render
            document.getElementById('yAxisLabel').textContent = state.riskDimensions[0]?.name || '';
            document.getElementById('xAxisLabel').textContent = state.riskDimensions[1]?.name || '';
        }

        function renderRiskRanges() {
            const container = document.getElementById('riskRangesList');
            container.innerHTML = '';
            state.riskRanges.forEach(range => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-3 p-3 bg-slate-50 dark:bg-slate-800/50 rounded-xl group hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors';
                div.innerHTML = `
                <div class="relative w-7 h-7 flex-shrink-0">
                    <input type="color" value="${range.color}" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer z-10"
                        oninput="updateRiskRange('${range.id}','color',this.value); this.nextElementSibling.style.backgroundColor=this.value">
                    <div class="w-7 h-7 rounded-lg border border-slate-200 dark:border-slate-600 shadow-sm" style="background-color:${range.color}"></div>
                </div>
                <input type="text" value="${range.label}" class="bg-transparent font-medium text-sm flex-1 outline-none focus:ring-1 focus:ring-primary/30 rounded px-1"
                    oninput="updateRiskRange('${range.id}','label',this.value)">
                <div class="flex items-center space-x-1.5">
                    <input type="number" value="${range.min}" class="w-14 text-center p-1 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-xs"
                        oninput="updateRiskRange('${range.id}','min',parseInt(this.value)||0)">
                    <span class="text-slate-400 text-xs">-</span>
                    <input type="number" value="${range.max}" class="w-14 text-center p-1 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-xs"
                        oninput="updateRiskRange('${range.id}','max',parseInt(this.value)||0)">
                </div>
                <button onclick="removeRiskRange('${range.id}')" class="text-slate-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100">
                    <span class="material-symbols-outlined text-lg">delete</span>
                </button>
            `;
                container.appendChild(div);
            });
        }

        function addRiskRange() {
            const lastMax = state.riskRanges.length > 0 ? Math.max(...state.riskRanges.map(r => r.max)) : 0;
            state.riskRanges.push({ id: Date.now().toString(), min: lastMax + 1, max: lastMax + 5, label: 'Novo Nível', color: '#3b82f6' });
            renderRisk();
        }

        function removeRiskRange(id) {
            state.riskRanges = state.riskRanges.filter(r => r.id !== id);
            renderRisk();
        }

        function updateRiskRange(id, field, value) {
            state.riskRanges = state.riskRanges.map(r => r.id === id ? { ...r, [field]: value } : r);
            if (field !== 'label') renderHeatmap();
        }

        function renderHeatmap() {
            const maxVal = state.riskRanges.length > 0 ? Math.max(...state.riskRanges.map(r => r.max)) : 25;
            const axisLimit = Math.min(22, Math.max(5, Math.ceil(Math.sqrt(maxVal))));
            const grid = document.getElementById('heatmapGrid');
            grid.style.gridTemplateColumns = `repeat(${axisLimit}, minmax(0, 1fr))`;
            grid.innerHTML = '';

            const getColor = (score) => {
                const range = state.riskRanges.find(r => score >= r.min && score <= r.max);
                return range ? range.color : '#e5e7eb';
            };

            const fontSize = axisLimit > 15 ? '7px' : axisLimit > 10 ? '9px' : '10px';

            for (let y = axisLimit; y >= 1; y--) {
                for (let x = 1; x <= axisLimit; x++) {
                    const score = x * y;
                    const cell = document.createElement('div');
                    cell.className = 'aspect-square flex items-center justify-center text-white font-bold rounded-sm transition-all hover:scale-110 cursor-pointer shadow-sm border border-white/10';
                    cell.style.backgroundColor = getColor(score);
                    cell.style.fontSize = fontSize;
                    cell.textContent = axisLimit > 12 && score > 99 ? '++' : score;
                    cell.title = `Score (X:${x} × Y:${y}) = ${score}`;
                    grid.appendChild(cell);
                }
            }

            document.getElementById('yAxisLabel').textContent = state.riskDimensions[0]?.name || '';
            document.getElementById('xAxisLabel').textContent = state.riskDimensions[1]?.name || '';
            document.getElementById('heatmapInfo').textContent = `Grade ${axisLimit}×${axisLimit} (${axisLimit * axisLimit} blocos) — ${state.riskDimensions[0]?.name} vs ${state.riskDimensions[1]?.name}`;
        }

        function saveRisk() {
            saveState();
            showToast('Parametrização de Risco salva com sucesso!');
        }

        // =====================================================================
        // COMPLIANCE MATRIX EDITOR
        // =====================================================================
        function renderCompliance() {
            const tbody = document.getElementById('complianceTableBody');
            tbody.innerHTML = '';
            state.complianceRanges.forEach(range => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-50/50 dark:hover:bg-slate-800/30 transition-colors group';
                tr.innerHTML = `
                <td class="px-5 py-3.5">
                    <div class="flex items-center space-x-1.5">
                        <input type="number" value="${range.min}" class="w-14 p-1.5 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-xs text-center focus:ring-2 focus:ring-primary/50 outline-none"
                            oninput="updateComplianceRange('${range.id}','min',parseInt(this.value)||0)">
                        <span class="text-slate-400">-</span>
                        <input type="number" value="${range.max}" class="w-14 p-1.5 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-xs text-center focus:ring-2 focus:ring-primary/50 outline-none"
                            oninput="updateComplianceRange('${range.id}','max',parseInt(this.value)||0)">
                    </div>
                </td>
                <td class="px-5 py-3.5">
                    <input type="text" value="${range.label}" class="w-full p-1.5 rounded-lg border border-transparent hover:border-slate-200 focus:border-slate-200 bg-transparent text-sm font-medium focus:ring-2 focus:ring-primary/50 outline-none"
                        oninput="updateComplianceRange('${range.id}','label',this.value)">
                </td>
                <td class="px-5 py-3.5">
                    <div class="relative w-8 h-8">
                        <input type="color" value="${range.color}" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer z-10"
                            oninput="updateComplianceRange('${range.id}','color',this.value); this.nextElementSibling.style.backgroundColor=this.value">
                        <div class="w-8 h-8 rounded-lg border border-slate-200 dark:border-slate-600 shadow-sm hover:scale-110 transition-transform" style="background-color:${range.color}"></div>
                    </div>
                </td>
                <td class="px-5 py-3.5 text-center">
                    <input type="radio" name="complianceThreshold" ${state.notificationThresholdId === range.id ? 'checked' : ''}
                        class="form-radio text-primary focus:ring-primary w-5 h-5 border-slate-300 dark:border-slate-600 cursor-pointer"
                        onchange="state.notificationThresholdId='${range.id}'; updateComplianceThresholdLabel()">
                </td>
                <td class="px-5 py-3.5 text-right">
                    <button onclick="removeComplianceRange('${range.id}')" class="text-slate-300 hover:text-red-500 transition-colors p-1 rounded-full hover:bg-red-50">
                        <span class="material-symbols-outlined text-xl">delete</span>
                    </button>
                </td>
            `;
                tbody.appendChild(tr);
            });
            renderComplianceViz();
            updateComplianceThresholdLabel();
        }

        function renderComplianceViz() {
            const bar = document.getElementById('complianceVizBar');
            bar.innerHTML = '';
            state.complianceRanges.forEach(range => {
                const width = Math.max(range.max - range.min + 1, 0);
                if (width <= 0) return;
                const seg = document.createElement('div');
                seg.className = 'h-full flex items-center justify-center text-[10px] text-white font-bold transition-all hover:brightness-110 cursor-help relative group/tip';
                seg.style.width = width + '%';
                seg.style.backgroundColor = range.color;
                if (width > 8) seg.textContent = range.label;
                const tip = document.createElement('div');
                tip.className = 'absolute -top-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover/tip:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-10 shadow-lg';
                tip.textContent = `${range.label}: ${range.min}% - ${range.max}%`;
                seg.appendChild(tip);
                bar.appendChild(seg);
            });
        }

        function updateComplianceThresholdLabel() {
            const r = state.complianceRanges.find(r => r.id === state.notificationThresholdId);
            document.getElementById('complianceThresholdLabel').textContent = r ? `"${r.label}"` : '"Nível Selecionado"';
        }

        function addComplianceRange() {
            const lastMax = state.complianceRanges.length > 0 ? Math.max(...state.complianceRanges.map(r => r.max)) : 0;
            state.complianceRanges.push({ id: Date.now().toString(), min: Math.min(lastMax + 1, 100), max: Math.min(lastMax + 10, 100), label: 'Novo Nível', color: '#94a3b8' });
            renderCompliance();
        }

        function removeComplianceRange(id) {
            state.complianceRanges = state.complianceRanges.filter(r => r.id !== id);
            if (state.notificationThresholdId === id && state.complianceRanges.length > 0) {
                state.notificationThresholdId = state.complianceRanges[0].id;
            }
            renderCompliance();
        }

        function updateComplianceRange(id, field, value) {
            state.complianceRanges = state.complianceRanges.map(r => r.id === id ? { ...r, [field]: value } : r);
            renderComplianceViz();
            if (field === 'label') updateComplianceThresholdLabel();
        }

        function saveCompliance() {
            saveState();
            showToast('Parametrização de Conformidade salva com sucesso!');
        }

        // =====================================================================
        // MAINTENANCE MATRIX EDITOR
        // =====================================================================
        function renderMaintenance() {
            const riskLabels = state.riskRanges.map(r => r.label);
            const compLabels = state.complianceRanges.map(c => c.label);

            // Ensure all combos exist in state
            riskLabels.forEach(r => {
                compLabels.forEach(c => {
                    const key = `${r}-${c}`;
                    if (!state.maintenanceMatrix[key]) {
                        state.maintenanceMatrix[key] = 'Em manutenção sem acompanhamento';
                    }
                });
            });

            const table = document.getElementById('maintenanceTable');
            table.innerHTML = '';

            // Header
            const thead = document.createElement('thead');
            let headerRow = '<tr><th class="p-4 bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700 text-[10px] font-bold text-slate-400 uppercase tracking-widest text-left w-48">Risco \\ Conformidade</th>';
            compLabels.forEach(c => {
                headerRow += `<th class="p-4 bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700 text-sm font-bold text-slate-700 dark:text-slate-300 text-center">${c}</th>`;
            });
            headerRow += '</tr>';
            thead.innerHTML = headerRow;
            table.appendChild(thead);

            // Body
            const tbody = document.createElement('tbody');
            riskLabels.forEach(r => {
                let row = `<tr><td class="p-4 border border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 font-bold text-sm text-slate-700 dark:text-slate-300 whitespace-nowrap">Risco ${r}</td>`;
                compLabels.forEach(c => {
                    const key = `${r}-${c}`;
                    const action = state.maintenanceMatrix[key] || MAINTENANCE_ACTIONS[0];
                    const colorClass = getMaintenanceColor(action);
                    row += `<td class="p-3 border border-slate-100 dark:border-slate-700 cursor-pointer transition-all hover:brightness-95 active:scale-95"
                            onclick="cycleMaintenanceCell('${r}','${c}')">
                            <div class="text-[10px] font-bold uppercase p-2.5 rounded-lg border text-center ${colorClass} transition-colors">${action}</div>
                        </td>`;
                });
                row += '</tr>';
                tbody.innerHTML += row;
            });
            table.appendChild(tbody);
        }

        function getMaintenanceColor(action) {
            switch (action) {
                case 'Necessita plano de ação': return 'bg-red-50 text-red-700 border-red-200 dark:bg-red-900/20 dark:text-red-400 dark:border-red-800';
                case 'Em manutenção com acompanhamento': return 'bg-amber-50 text-amber-700 border-amber-200 dark:bg-amber-900/20 dark:text-amber-400 dark:border-amber-800';
                default: return 'bg-emerald-50 text-emerald-700 border-emerald-200 dark:bg-emerald-900/20 dark:text-emerald-400 dark:border-emerald-800';
            }
        }

        function cycleMaintenanceCell(risk, compliance) {
            const key = `${risk}-${compliance}`;
            const current = state.maintenanceMatrix[key] || MAINTENANCE_ACTIONS[0];
            const nextIdx = (MAINTENANCE_ACTIONS.indexOf(current) + 1) % MAINTENANCE_ACTIONS.length;
            state.maintenanceMatrix[key] = MAINTENANCE_ACTIONS[nextIdx];
            renderMaintenance();
        }

        function saveMaintenance() {
            saveState();
            showToast('Matriz de Manutenção salva com sucesso!');
        }

        // =====================================================================
        // INIT
        // =====================================================================
        document.addEventListener('DOMContentLoaded', () => {
            switchTab('risk');
        });
    </script>
</body>

</html>